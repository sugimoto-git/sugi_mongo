# MongoDBのマルチドキュメントトランザクションに関する形式検証レポート

## 1. 検証対象のOSS概要
MongoDB は、NoSQLドキュメント指向データベースである。今回の課題では、マルチドキュメントトランザクションの競合処理に着目し、Alloyを用いて形式検証を行った。

## 2. 検証すべき性質

### **Atomicity (原子性)**
- トランザクションがコミットされる場合、対象ドキュメントは一括で変更が反映され、部分的な更新が残らない。

### **Isolation (分離性)**
- 同じドキュメントを更新する複数トランザクションが同時にコミットされることはない（競合すれば一方が失敗または再試行される）。

## 3. モデル化
Alloyで単純化したモデルを作成し、alloy_practiceフォルダに配置した（mongoTxModel.als）。

### **モデルのポイント**
- `TxState` は `{Active, Committed, Aborted}` の3種類。
- `Tx` はトランザクションを表し、どのドキュメント（`updates`）を更新しようとしているかを示す。
- `fact isolation` では「競合する2つのTx（同じドキュメントを更新）が両方Committedになることはない」ことを定義。
- `assert noDoubleCommit` は上記Isolationを検証するための安全性チェック。
- `assert atomicCommit` は、コミットされたTxの更新は部分的にしか適用されない、という不整合がないかを簡易的に検証するためのアサーション。

## 4. 検証手法

### **小スコープ仮説の活用**
- Alloyのスコープを `for 5` として、
  - `Tx（最大5つ）`
  - `Document（最大5つ）`
  の組み合わせを全探索し、競合のパターンを網羅的に確認した。

### **Safetyの検証**
- `noDoubleCommit` アサーションに対して `check noDoubleCommit for 5` を実行し、反例がないかを確認した。
- `atomicCommit` アサーションに対しても同様に `check atomicCommit for 5` を行い、部分コミットのような反例がないかを確認した。

## 5. Alloy実行結果


#### **Alloyのコンソール出力例:**
```plaintext
Executing "Check noDoubleCommit for 5"
   No counterexample found. Assertion may be valid.
```

つまり、スコープ `5` の範囲内で「同じドキュメントを更新する2つのトランザクションが両方Committedになる反例」は見つからず、Isolationが破綻するケースは発生しなかった。


## 6. 考察
- 小スコープ（Tx数とドキュメント数を各5まで）で競合による2重コミットは確認されず、部分コミットに関する反例も発生しなかった。
- これは **「競合するTxが同時にコミットしない」というMongoDBのIsolationを満たす性質が、小スコープ内で確認できた** ことを示唆する。
- 実際のMongoDBは **レプリカセット、シャード、ロック機構** など多岐にわたる要素を持ち、本モデルは非常に簡略化しているため、
  - **時相的振る舞い** や **ノード障害時の挙動** は対象外。
  - それでも、**競合管理のコア部分**（同じドキュメントを更新するTxの同時コミットが禁止される点）を **形式的に確認** できたのは意義がある。

## 7. 今後の拡張案

- **時相論理の導入**: トランザクションが開始→更新→コミットに至る時間的順序を記述して、よりリアルに競合を扱う。
- **分散環境のモデル化**: レプリカセットやシャードをシグネチャとして追加し、それぞれのノードでのデータ状態を比較する。
- **エラー/ロールバックシナリオ**: 特定のタイミングで障害が起きた場合に、トランザクションが確実にロールバックされているか。

